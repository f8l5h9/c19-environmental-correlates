---
title: "COVID-19-Spain-Analysis"
author: "F.A. Lopez and A. Paez"
date: "4/11/2020"
output: html_document
---

This notebook reports our initial analysis of COVID-19 incidence in Spain and the climatic correlates of incidence. The data have been organized in a package for ease of access and distribution. The name of the package is `covid19env` and if necessary can be installed from the GitHub repository.

## Preliminaries

Load packages:
```{r library, collapse=TRUE, message=FALSE}
library(covid19env)
library(ggthemes)
library(gridExtra)
library(lubridate)
library(sf)
library(spdep)
library(spsur)
library(tidyverse)
#library(spatialreg)
#library(systemfit)
#library(plm)
#library(splm)
```

Load data from package `covid19env`
```{r}
data("covid19_spain")
```

Summarize the data:
```{r}
covid19_spain %>% 
  select(-geometry) %>% 
  summary()
```

The dataframe is a simple features object with information at the level of the province. The dataframe includes information about the province, including its Autonomous Community (a superior jurisdiction), an identifier, dates, COVID-19 cases and incidence. The period covered is from March 14, 2020 to April 4, 2020. In addition there are some demographic controls, and various climatic variables. Of interest are the lagged variables. The lagged variables are 8-day moving averages calculated using date-minus-12-days to date-minus-5-days, to account for the latency of the infection. More information about the dataset can be obtained by typing `?covid18_spain`.

There are 50 provinces in Spain:
```{r}
nlevels(covid19_spain$province)
```

Shelter in place order in Spain went into effect on March 16, 2020. March 14 is the first day that every province had at least one reported case of COVID-19.

## Data visualization

There are 22 days in the dataset. We can summarize the incidence by week (excluding Canarias):
```{r}
week11.plot <- covid19_spain %>% 
  filter(CCAA != "Canarias") %>%
  group_by(province, week = isoweek(Date)) %>% 
  summarise(mean_weekly_incidence = mean(Incidence)) %>%
  filter(week == 11) %>%
  ggplot() +
  geom_sf(aes(fill = mean_weekly_incidence)) +
  scale_fill_distiller(name = "Mean Weekly Incidence", 
                       palette = "Reds", 
                       direction = 1) +
  theme_tufte() +
  theme(axis.text = element_blank(),
        legend.position = "bottom") + 
  facet_wrap(~week)

week12.plot <- covid19_spain %>% 
  filter(CCAA != "Canarias") %>%
  group_by(province, week = isoweek(Date)) %>% 
  summarise(mean_weekly_incidence = mean(Incidence)) %>%
  filter(week == 12) %>%
  ggplot() +
  geom_sf(aes(fill = mean_weekly_incidence)) +
  scale_fill_distiller(name = "Mean Weekly Incidence", 
                       palette = "Reds",
                       direction = 1) +
  theme_tufte() +
  theme(axis.text = element_blank(),
        legend.position = "bottom") + 
  facet_wrap(~week)

week13.plot <- covid19_spain %>% 
  filter(CCAA != "Canarias") %>%
  group_by(province, week = isoweek(Date)) %>% 
  summarise(mean_weekly_incidence = mean(Incidence)) %>%
  filter(week == 13) %>%
  ggplot() +
  geom_sf(aes(fill = mean_weekly_incidence)) +
  scale_fill_distiller(name = "Mean Weekly Incidence", 
                       palette = "Reds", 
                       direction = 1) +
  theme_tufte() +
  theme(axis.text = element_blank(),
        legend.position = "bottom") + 
  facet_wrap(~week)

week14.plot <- covid19_spain %>% 
  filter(CCAA != "Canarias") %>%
  group_by(province, week = isoweek(Date)) %>% 
  summarise(mean_weekly_incidence = mean(Incidence)) %>%
  filter(week == 14) %>%
  ggplot() +
  geom_sf(aes(fill = mean_weekly_incidence)) +
  scale_fill_distiller(name = "Mean Weekly Incidence", 
                       palette = "Reds", 
                       direction = 1) +
  theme_tufte() +
  theme(axis.text = element_blank(),
        legend.position = "bottom") + 
  facet_wrap(~week)

grid.arrange(week11.plot, week12.plot, week13.plot, week14.plot, nrow = 2)
```

We consider two control variables: ratio of male to female in the province, and median age of the population:
```{r}
covid19_spain %>% 
  filter(CCAA != "Canarias") %>%
  ggplot() +
  geom_sf(aes(fill = Male2Female)) +
  scale_fill_distiller(name = "Male to Female Ratio", 
                       palette = "Blues", 
                       direction = 1) +
  theme_tufte() +
  theme(axis.text = element_blank(),
        legend.position = "bottom")
```

```{r}
covid19_spain %>% 
  filter(CCAA != "Canarias") %>%
  ggplot() +
  geom_sf(aes(fill = Median_Age)) +
  scale_fill_distiller(name = "Median Age of Population", 
                       palette = "Blues", 
                       direction = 1) +
  theme_tufte() +
  theme(axis.text = element_blank(),
        legend.position = "bottom")
```

We are also interested in the climatic variables. The following plot is the distribution of temperature by CCAA:
```{r}
# Autonomous communities
ccaa.sf <- covid19_spain %>% 
  filter(Date == "2020-03-14") %>% 
  group_by(CCAA) %>% 
  summarize(provinces = n())

# Extract coordinates of autonomous communities
ccaa.coords <- ccaa.sf %>%
  st_centroid() %>%
  st_coordinates() %>%
  as.data.frame()

# Join Y coordinate to ccaa.sf
ccaa.sf <- ccaa.sf %>% 
  mutate(long = ccaa.coords$Y)

# Sort autonomous communities from north to south
ccaa.levels <- ccaa.sf %>% 
  arrange(desc(long)) %>% select(CCAA)

ccaa.levels <- as.character(ccaa.levels$CCAA)

# Relevel autonomous communities
covid19_spain <- covid19_spain %>%
  mutate(CCAA = factor(CCAA, levels = ccaa.levels, ordered = TRUE))

# Boxplots of temperatures
covid19_spain %>% 
  st_drop_geometry() %>%
  group_by(CCAA, Date) %>%
  summarize(Mean_Temp = mean(Mean_Temp)) %>%
  ggplot(aes(x = CCAA, y = Mean_Temp)) +
  geom_boxplot() +
  theme_tufte() +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Autonomous Community (sorted from north to south)") +
  ylab("Mean Temperature in the Community")
```

## Multivariate analysis: comparison of approaches

### Panel

1) Panel clásico

1) Panel Clásico o Dinámico

* Debe ser un modelo de efectos fijos para recoger la hetereogeneidad entre las distintas provincias (efectos)
* Debería incluir estructura dinámica ya que la serie tiene una fuerte estrutura temporal
* INCONVENIENTE: considera que la incluencia del dato del día anterior es constante (se estima un coeficiente constante)
* INCONVENIENTE: No se pueden incluir varaibles constantes en T. La hetereogeneidad entre provincias queda en el efecto fijo. No podemos por tanto incluir datos sobre estructura de la poblacion.
* INCONVENIENTE: No podemos incorporar efectos espaciales. El paquete **splm** no incluye estimación de paneles dinámicos con efectos espaciales. Tendriamos que hacerlo en matlab con los códigos de P.Elhorst.

### Spatial SUR

2) SUR espacial

* Hay un coeficente para cada variable y cada instante de tiempo. Aunque es posible considerar coeficientes constantes para los periodos temporales que consideremos.
* La hetereoeneidad espacial debemos incorporarla mediante variables explicativas. --> Estructura de la población relacionada con COVID-19.
* Permite incluir varaibles constantes en T.
* la dinámica temporar quedará recogida mediante el término independiente y la estructura de correlaciones en los residuos. EN TODO CASO, ENTIENDO QUE NUESTRO OBJETIVO NO ES EXPLICAR ESA TENEDENCIA TEMPORAL (solo modelizarla para no incurrir en errores)


## Panel

### Prepare data for panel analysis
```{r}
######################################
# Panel clásico
######################################
# Construccion del Panel
Panel <- as.factor(rep(provincias.sf$PROVINCIA,22))
Panel <- as.data.frame(Panel)
names(Panel) <- c("index")
Panel$time <- as.integer(Matrix::kronecker(1:22,rep(1,50)))
Panel$PROV <- as.factor(rep(provincias.sf$ID_INE,22))
Panel$Inc <- matrix(as.matrix(Inc[,1:22]),ncol=1) 
Panel$HM <- rep(provincias.sf$HOM_MUJ,22)
Panel$EM <- rep(provincias.sf$EDAD_MED,22)
Panel$COSTA <- rep(provincias.sf$COSTA,22)
Panel$ALTITUD <- rep(provincias.sf$ALTITUD,22)
Panel$Lat <- rep(provincias.sf$Lat,22)
Panel$TMax <- matrix(as.matrix(TMax[,17:38]),ncol=1)
Panel$TMed <- matrix(as.matrix(TMed[,17:38]),ncol=1)
Panel$TMedmm <- matrix(as.matrix(TMedmm[,10:31]),ncol=1)
Panel$Hummm <- matrix(as.matrix(Hummm[,10:31]),ncol=1)
Panel$Sunmm <- matrix(as.matrix(Sunmm[,10:31]),ncol=1)
Panel$Plumm <- matrix(as.matrix(Plumm[,10:31]),ncol=1)
Panel <- Panel[order(Panel$index),]
```

## Panel Clásico NO dinámico

**El modelo debe considerar efectos del 'individuo' y del 'tiempo' (para incorporar tendencia temporal)**

```{r}
# Definicion del panel para plm
GPanel2 <- plm::pdata.frame(covid19_spain %>% 
                              st_drop_geometry() %>%
                              select(province, 
                                     Date,
                                     Incidence, 
                                     Median_Age,
                                     Male2Female,
                                     Mean_Temp_lag,
                                     Humidity_lag,
                                     Sunshine_Hours_lag),
                            c("province","Date"))

formula <- log(Incidence) ~ log(Mean_Temp_lag) + log(Humidity_lag) + log(Sunshine_Hours_lag + .1)
model.ef <-  plm::plm(formula, data = GPanel2, model = "within",effect = "twoways")
summary(model.ef)
```
**RESUMEN modelo efectos fijos**

1) La temperatura no es relevante. Probablemente ha sido incorporada en el efecto fijo asociado a cada provincia.
2) Las horas de sol y la humedad aparecen con signos contrarios a lo espetado ¿?¿?
3) El test de Hausman no reportado confirma que ef es preferible.

## Panel NO dinámico con efectos espaciales

Construcción de W

```{r}
# Definición matrix de contactos 
junk <- covid19_spain %>% 
  filter(Date == "2020-03-14") %>%
  as("Spatial") %>%
  poly2nb(queen = FALSE) %>%
  nb2mat(zero.policy = T)

junk <- (junk > 0) * 1

#W <- poly2nb(as(provincias.sf, "Spatial"), queen = FALSE)
#Wmat <- nb2mat(W,zero.policy = T)
#Wmat <- (Wmat>0)*1
# Conexión de las dos provincias que forman Canarias
junk[37, 44] <- 1
junk[44, 37] <- 1
# 'Paises Catalans'
n = 8
junk[9,n] <- 1
junk[n,9] <- 1
junk[n,47] <- 1
junk[47,n] <- 1
junk[n,43] <- 1
junk[43,n] <- 1
miW <- junk/rowSums(junk)
junkw <- mat2listw(junk,style = "W")
```


```{r, warning=FALSE}
# Modelo Pool
formula <- log(Inc) ~ log(TMedmm) +  log(Sunmm + 1) + log(Hummm)
model.splm <- spml(formula = formula, data = GPanel, 
                   index = NULL, listw = listw, model = "within", effect="twoways" ,lag = TRUE, spatial.error = "none")
summary(model.splm)
```

**RESUMEN modelo efectos fijos**

1) Igual que el No dinámico
2) Hay efectos espaciales

## Panel Dinámico

```{r, warning=FALSE}
######################################
# Panel DINAMICO
######################################

## Panel dinámico con dynpanel
modelo.dinamico <- dynpanel::dpd(log(Inc) ~ log(TMedmm) + log(Hummm) + log(Sunmm+0.1),Panel,index=c("index","time"),1,4) 
## 1 representa el orden de autocorrelación y 4 método Arellano&Bond(1991)
summary(modelo.dinamico)
```
**RESUMEN modelo efectos fijos**

1) Ninguna varaible climatologia es relevante. El tiempo se lo 'come todo'

# Modelo SUR espacial

Se incluyen dos variables de control para recoger la herogeneidad espacial
* HM: ratio Hombres/Mujeres (signo esperado +)
* EM: Edad media (signo esperado +)

```{r}
formula <- log(Incidence) ~ log(Male2Female) + 
  log(Median_Age) + 
  log(Mean_Temp_lag) + 
  log(Sunshine_Hours_lag + 0.1) + 
  log(Humidity_lag)
model.sur.slm <- spsur::spsurtime(formula = formula, data=GPanel2, time = GPanel2$Date, type = "slm", fit_method = "3sls", listw=junkw)
summary(model.sur.slm)
```

## Dinámica temporal de la dependencia espacial (Coef lambda estimado en las T=22 ecuaciones)

```{r}
mydates[14:35]
```


```{r}
x <- model.sur.slm$deltas
tvalue <- model.sur.slm$deltas/model.sur.slm$deltas.se
mycolor <- rep("blue",22)
mycolor[abs(tvalue)>1.64] <- "red"
plot(1:22, x, type="b", pch = 19,col=mycolor, main="Dinamica temporal dependencia espacial")
abline(v=c(3,10), col= c("red","blue"))
abline(h=0, col= c("black"))
```

* La estructura de dependencia espacial, pasa de positiva (significativa) a no significativa para finalmente ser negativa (significativa)
* Esto puede explicarse:
- en una PRIMERA ETAPA al inicio del brote epidémico había contagio entre provincias colindantes.
- en una SEGUNDA ETAPA Al introducir medidas de confinamiento las provincias quedaron 'aisladas' y cada una creció a un ritmo diferente. La estructura de dependencia espacial se 'disolvió'
-  en una TERCERA ETAPA, en muchas provincias se controló parcialmente la epidemia. Salvo en X-provincias que siguieron creciendo fuertemente. Eso dio lugar a patrones de dependencia espacial negativa.

# Analisis de los residuos del Modelo SUR sin efectos espaciales

```{r}
formula <- log(Incidence) ~ log(Male2Female) + 
  log(Median_Age) + 
  log(Mean_Temp_lag) + 
  log(Sunshine_Hours_lag + 0.1) + 
  log(Humidity_lag)
model.sur <- spsur::spsurtime(formula = formula, data=GPanel2, time = GPanel2$Date, type = "sim")
residuos.sur <- as.matrix(residuals(model.sur))
```

Plot residuals on March 16:
```{r}
covid19_spain %>% filter(Date == "2020-03-16") %>% 
  mutate(ResMarch16 = residuos.sur[[3]]) %>% 
  filter(CCAA != "Canarias") %>%
  ggplot() +
  geom_sf(aes(fill = ResMarch16)) +
  scale_fill_distiller(palette = "RdBu", direction = 1) +
  theme_tufte()
```

Plot residuals on April 2:
```{r}
covid19_spain %>% filter(Date == "2020-03-16") %>% 
  mutate(ResApr02 = residuos.sur[[21]]) %>% 
  filter(CCAA != "Canarias") %>%
  ggplot() +
  geom_sf(aes(fill = ResApr02)) +
  scale_fill_distiller(palette = "RdBu", direction = 1) +
  theme_tufte()
```

## Dinámica temporal de Variables de Control

### ratio HM

* No es significativa (signo esperado)

```{r}
mydates[14:35]
n=2
x <- matrix(model.sur.slm$coefficients,ncol = 22)[n,]
tvalue <- matrix(model.sur.slm$coefficients/model.sur.slm$rest.se,ncol = 22)[n,]
mycolor <- rep("blue",22)
mycolor[abs(tvalue)>1.64] <- "red"
plot(1:22,x,type="b",pch = 19,col=mycolor)
abline(v=c(3,10), col= c("red","blue"))
```

### Edad Media

* Los coeficientes de las variables de control (EM y HM) tienen el signo esperado
* Los primeros días tienen valores elevados cuando la pandemía no estaba controlada (aún no había confinamiento)
```{r}
mydates[14:35]
n=3
x <- matrix(model.sur.slm$coefficients,ncol = 22)[n,]
tvalue <- matrix(model.sur.slm$coefficients/model.sur.slm$rest.se,ncol = 22)[n,]
mycolor <- rep("blue",22)
mycolor[abs(tvalue)>1.64] <- "red"
plot(1:22,x,type="b",pch = 19,col=mycolor)
abline(v=c(3,10), col= c("red","blue"))
```

## Dinámica temporal de Variables Climáticas

### TEMPERATURA


* Los coeficientes de las variables de control (EM y HM) tienen el signo esperado
* Los primeros días tienen valores elevados cuando la pandemía no estaba controlada (aún no había confinamiento)
```{r}
mydates[14:35]
n=4
x <- matrix(model.sur.slm$coefficients,ncol = 22)[n,]
tvalue <- matrix(model.sur.slm$coefficients/model.sur.slm$rest.se,ncol = 22)[n,]
mycolor <- rep("blue",22)
mycolor[abs(tvalue)>1.64]="red"
plot(1:22,x,type="b",pch = 19,col=mycolor)
abline(v=c(3,10), col= c("red","blue"))
```
### Humedad

```{r}
mydates[14:35]
n=5
x <- matrix(model.sur.slm$coefficients,ncol = 22)[n,]
tvalue <- matrix(model.sur.slm$coefficients/model.sur.slm$rest.se,ncol = 22)[n,]
mycolor <- rep("blue",22)
mycolor[abs(tvalue)>1.64]="red"
plot(1:22,x,type="b",pch = 19,col=mycolor)
abline(v=c(3,10), col= c("red","blue"))
```



### HORAS de Sol

```{r}
mydates[14:35]
n=5
x <- matrix(model.sur.slm$coefficients,ncol = 22)[n,]
tvalue <- matrix(model.sur.slm$coefficients/model.sur.slm$rest.se,ncol = 22)[n,]
mycolor <- rep("blue",22)
mycolor[abs(tvalue)>1.64]="red"
plot(1:22,x,type="b",pch = 19,col=mycolor)
abline(v=c(3,10), col= c("red","blue"))
```


### El intercepto


```{r}
mydates[14:35]
n=1
x <- matrix(model.sur.slm$coefficients,ncol = 22)[n,]
tvalue <- matrix(model.sur.slm$coefficients/model.sur.slm$rest.se,ncol = 22)[n,]
mycolor <- rep("blue",22)
mycolor[abs(tvalue)>1.64]="red"
plot(1:22,x,type="b",pch = 19,col=mycolor)
abline(v=c(3,10), col= c("red","blue"))
legend("topleft", legend=c("signific", "Nosign"),
       col=c("red", "blue"), lty = 1:2)
```

# ESTIMAR SUR ESPACIAL CON COEFICIENTES COSTANTES

formula <- log(Inc) ~ log(HM) + log(EM) + log(TMedmm) + log(Sunmm+.1) + log(Hummm)

coef_rest = 5
R2 <- matrix(0,nrow = 21*coef_rest,ncol = 6*22)
for (i in 1:21){
R2[i,2] <- 1
R2[i,(2+i*6)] <- -1
R2[i+21,3] <- 1
R2[i+21,(3+i*6)] <- -1
R2[i+21*2,4] <- 1
R2[i+21*2,(4+i*6)] <- -1
R2[i+21*3,5] <- 1
R2[i+21*3,(5+i*6)] <- -1
R2[i+21*4,6] <- 1
R2[i+21*4,(6+i*6)] <- -1

# R2[2,2] <- 1
# R2[2,(2+2*6)] <- -1
# R2[3,2] <- 1
# R2[3,(2+3*6)] <- -1
}
b2 <- matrix(0, ncol=21*coef_rest)

panel.sur.slm <- spsurtime(formula = formula, data=GPanel, time = GPanel$time, R=R2, b=b2, type = "sim")
summary(panel.sur.slm)