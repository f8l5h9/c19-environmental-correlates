---
title: "COVID-19-Spain-Analysis"
author: "F.A. Lopez and A. Paez"
date: "4/11/2020"
output:
  pdf_document: default
  html_document: default
---

This notebook reports our initial analysis of COVID-19 incidence in Spain and the climatic correlates of incidence. The data have been organized in a package for ease of access and distribution. The name of the package is `covid19env` and if necessary can be installed from the GitHub repository.

## Preliminaries

Load packages:
```{r library, collapse=TRUE, message=FALSE}
library(covid19env)
library(ggthemes)
library(gridExtra)
library(lubridate)
library(sf)
library(spdep)
library(spsur)
library(tidyverse)
#library(spatialreg)
#library(systemfit)
#library(plm)
#library(splm)
```

Load data from package `covid19env`
```{r}
data("covid19_spain")
```

Summarize the data:
```{r}
covid19_spain %>% 
  select(-geometry) %>% 
  summary()
```

The dataframe is a simple features object with information at the level of the province. The dataframe includes information about the province, including its Autonomous Community (a superior jurisdiction), an identifier, dates, COVID-19 cases and incidence. The period covered is from March 14, 2020 to April 4, 2020. In addition there are some demographic controls, and various climatic variables. Of interest are the lagged variables. The lagged variables are 8-day moving averages calculated using date-minus-12-days to date-minus-5-days, to account for the latency of the infection. More information about the dataset can be obtained by typing `?covid18_spain`.

There are 50 provinces in Spain:
```{r}
nlevels(covid19_spain$province)
```

Shelter in place order in Spain went into effect on March 16, 2020. March 14 is the first day that every province had at least one reported case of COVID-19.

## Data visualization

There are 22 days in the dataset. We can summarize the incidence by week (excluding Canarias):
```{r}
week11.plot <- covid19_spain %>% 
  filter(CCAA != "Canarias") %>%
  group_by(province, week = isoweek(Date)) %>% 
  summarise(mean_weekly_incidence = mean(Incidence)) %>%
  filter(week == 11) %>%
  ggplot() +
  geom_sf(aes(fill = mean_weekly_incidence)) +
  scale_fill_distiller(name = "Mean Weekly Incidence", 
                       palette = "Reds", 
                       direction = 1) +
  theme_tufte() +
  theme(axis.text = element_blank(),
        legend.position = "bottom") + 
  facet_wrap(~week)

week12.plot <- covid19_spain %>% 
  filter(CCAA != "Canarias") %>%
  group_by(province, week = isoweek(Date)) %>% 
  summarise(mean_weekly_incidence = mean(Incidence)) %>%
  filter(week == 12) %>%
  ggplot() +
  geom_sf(aes(fill = mean_weekly_incidence)) +
  scale_fill_distiller(name = "Mean Weekly Incidence", 
                       palette = "Reds",
                       direction = 1) +
  theme_tufte() +
  theme(axis.text = element_blank(),
        legend.position = "bottom") + 
  facet_wrap(~week)

week13.plot <- covid19_spain %>% 
  filter(CCAA != "Canarias") %>%
  group_by(province, week = isoweek(Date)) %>% 
  summarise(mean_weekly_incidence = mean(Incidence)) %>%
  filter(week == 13) %>%
  ggplot() +
  geom_sf(aes(fill = mean_weekly_incidence)) +
  scale_fill_distiller(name = "Mean Weekly Incidence", 
                       palette = "Reds", 
                       direction = 1) +
  theme_tufte() +
  theme(axis.text = element_blank(),
        legend.position = "bottom") + 
  facet_wrap(~week)

week14.plot <- covid19_spain %>% 
  filter(CCAA != "Canarias") %>%
  group_by(province, week = isoweek(Date)) %>% 
  summarise(mean_weekly_incidence = mean(Incidence)) %>%
  filter(week == 14) %>%
  ggplot() +
  geom_sf(aes(fill = mean_weekly_incidence)) +
  scale_fill_distiller(name = "Mean Weekly Incidence", 
                       palette = "Reds", 
                       direction = 1) +
  theme_tufte() +
  theme(axis.text = element_blank(),
        legend.position = "bottom") + 
  facet_wrap(~week)

grid.arrange(week11.plot, week12.plot, week13.plot, week14.plot, nrow = 2)
```

We consider two control variables: ratio of male to female in the province, and median age of the population:
```{r}
covid19_spain %>% 
  filter(CCAA != "Canarias") %>%
  ggplot() +
  geom_sf(aes(fill = Male2Female)) +
  scale_fill_distiller(name = "Male to Female Ratio", 
                       palette = "Blues", 
                       direction = 1) +
  theme_tufte() +
  theme(axis.text = element_blank(),
        legend.position = "bottom")
```

```{r}
covid19_spain %>% 
  filter(CCAA != "Canarias") %>%
  ggplot() +
  geom_sf(aes(fill = Median_Age)) +
  scale_fill_distiller(name = "Median Age of Population", 
                       palette = "Blues", 
                       direction = 1) +
  theme_tufte() +
  theme(axis.text = element_blank(),
        legend.position = "bottom")
```

We are also interested in the climatic variables. The following plot is the distribution of temperature by CCAA:
```{r}
# Autonomous communities
ccaa.sf <- covid19_spain %>% 
  filter(Date == "2020-03-14") %>% 
  group_by(CCAA) %>% 
  summarize(provinces = n())

# Extract coordinates of autonomous communities
ccaa.coords <- ccaa.sf %>%
  st_centroid() %>%
  st_coordinates() %>%
  as.data.frame()

# Join Y coordinate to ccaa.sf
ccaa.sf <- ccaa.sf %>% 
  mutate(long = ccaa.coords$Y)

# Sort autonomous communities from north to south
ccaa.levels <- ccaa.sf %>% 
  arrange(desc(long)) %>% select(CCAA)

ccaa.levels <- as.character(ccaa.levels$CCAA)

# Relevel autonomous communities
covid19_spain <- covid19_spain %>%
  mutate(CCAA = factor(CCAA, levels = ccaa.levels, ordered = TRUE))

# Boxplots of temperatures
covid19_spain %>% 
  st_drop_geometry() %>%
  group_by(CCAA, Date) %>%
  summarize(Mean_Temp = mean(Mean_Temp)) %>%
  ggplot(aes(x = CCAA, y = Mean_Temp)) +
  geom_boxplot() +
  theme_tufte() +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Autonomous Community (sorted from north to south)") +
  ylab("Mean Temperature in the Community")
```

## Multivariate analysis: comparison of approaches

### Panel

1) Panel clásico

1) Panel Clásico o Dinámico

* Debe ser un modelo de efectos fijos para recoger la hetereogeneidad entre las distintas provincias (efectos)
* Debería incluir estructura dinámica ya que la serie tiene una fuerte estrutura temporal
* INCONVENIENTE: considera que la incluencia del dato del día anterior es constante (se estima un coeficiente constante)
* INCONVENIENTE: No se pueden incluir varaibles constantes en T. La hetereogeneidad entre provincias queda en el efecto fijo. No podemos por tanto incluir datos sobre estructura de la poblacion.
* INCONVENIENTE: No podemos incorporar efectos espaciales. El paquete **splm** no incluye estimación de paneles dinámicos con efectos espaciales. Tendriamos que hacerlo en matlab con los códigos de P.Elhorst.

### Spatial SUR

2) SUR espacial

* Hay un coeficente para cada variable y cada instante de tiempo. Aunque es posible considerar coeficientes constantes para los periodos temporales que consideremos.
* La hetereoeneidad espacial debemos incorporarla mediante variables explicativas. --> Estructura de la población relacionada con COVID-19.
* Permite incluir varaibles constantes en T.
* la dinámica temporar quedará recogida mediante el término independiente y la estructura de correlaciones en los residuos. EN TODO CASO, ENTIENDO QUE NUESTRO OBJETIVO NO ES EXPLICAR ESA TENEDENCIA TEMPORAL (solo modelizarla para no incurrir en errores)

## Prepare data for SUR analysis

*El modelo debe considerar efectos del 'individuo' y del 'tiempo' (para incorporar tendencia temporal)**

```{r}
# Definicion del panel para plm
GPanel <- plm::pdata.frame(covid19_spain %>% 
                              st_drop_geometry() %>%
                              select(province, 
                                     Date,
                                     Incidence, 
                                     Median_Age,
                                     Male2Female,
                                     Mean_Temp_lag8,
                                     Humidity_lag8,
                                     Sunshine_Hours_lag8,
                                     Mean_Temp_lag11,
                                     Humidity_lag11,
                                     Sunshine_Hours_lag11,
                                     Mean_Temp_lag11w,
                                     Humidity_lag11w,
                                     Sunshine_Hours_lag11w),
                            c("province","Date"))

```

# Modelo SUR espacial

Construcción de W

```{r}
# Definición matrix de contactos 
Wmat <- covid19_spain %>% 
  filter(Date == "2020-03-14") %>%
  as("Spatial") %>%
  poly2nb(queen = FALSE) %>%
  nb2mat(zero.policy = T)

Wmat <- (Wmat > 0) * 1

#W <- poly2nb(as(provincias.sf, "Spatial"), queen = FALSE)
#Wmat <- nb2mat(W,zero.policy = T)
#Wmat <- (Wmat>0)*1
# Conexión de las dos provincias que forman Canarias
Wmat[37, 44] <- 1
Wmat[44, 37] <- 1
# 'Paises Catalans'
n = 8
Wmat[9,n] <- 1
Wmat[n,9] <- 1
Wmat[n,47] <- 1
Wmat[47,n] <- 1
Wmat[n,43] <- 1
Wmat[43,n] <- 1
miW <- Wmat/rowSums(Wmat)
listw <- mat2listw(Wmat,style = "W")
```

Se incluyen dos variables de control para recoger la herogeneidad espacial
* HM: ratio Hombres/Mujeres (signo esperado +)
* EM: Edad media (signo esperado +)

Define formulas with two different lagged variables:
```{r}
formula_lag8 <- log(Incidence) ~ log(Male2Female) + 
  log(Median_Age) + 
  log(Mean_Temp_lag8) + 
  log(Sunshine_Hours_lag8 + 0.1) + 
  log(Humidity_lag8)

formula_lag11 <- log(Incidence) ~ log(Male2Female) + 
  log(Median_Age) + 
  log(Mean_Temp_lag11) + 
  log(Sunshine_Hours_lag11 + 0.1) + 
  log(Humidity_lag11)

formula_lag11w <- log(Incidence) ~ log(Male2Female) + 
  log(Median_Age) + 
  log(Mean_Temp_lag11w) + 
  log(Sunshine_Hours_lag11w + 0.1) + 
  log(Humidity_lag11w)
```

Model with 8-day moving average of climatic variables:
```{r}
sur.slm_lag8 <- spsur::spsurtime(formula = formula_lag8, 
                                  data=GPanel, 
                                  time = GPanel$Date, 
                                  type = "slm", 
                                  fit_method = "3sls", 
                                  listw=  listw)
summary(sur.slm_lag8)
```

Model with 11-day moving average of climatic variables:
```{r}
sur.slm_lag11 <- spsur::spsurtime(formula = formula_lag11, 
                                  data=GPanel, 
                                  time = GPanel$Date, 
                                  type = "slm", 
                                  fit_method = "3sls", 
                                  listw=  listw)
summary(sur.slm_lag11)
```

Model with 11-day weighted moving average of climatic variables:
```{r}
sur.slm_lag11w <- spsur::spsurtime(formula = formula_lag11w, 
                                  data=GPanel, 
                                  time = GPanel$Date, 
                                  type = "slm", 
                                  fit_method = "3sls", 
                                  listw=  listw)
summary(sur.slm_lag11w)
```

Compare goodness of fit:
```{r}
data.frame(R2_lag8 = sur.slm_lag8$R2, 
           R2_lag11 = sur.slm_lag11$R2,
           R2_lag11w = sur.slm_lag11w$R2) %>%
  slice(2:n()) %>%
  rownames_to_column(var = "Equation") %>%
  mutate(Date = seq(ymd("2020-03-14"), 
                        ymd("2020-04-04"), 
                            by = "days")) %>%
  pivot_longer(cols = starts_with("R"), names_to = "Model", values_to = "R2") %>%
  ggplot(aes(x = Date, y = R2, color = Model, shape = Model)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("R2_lag11w" = "blue", "R2_lag11" = "orange", "R2_lag8" = "green") ) + 
  theme_tufte()

```

## Dinámica temporal de la dependencia espacial (Coef lambda estimado en las T=22 ecuaciones)

```{r}
data.frame(Date = seq(ymd("2020-03-14"), 
                        ymd("2020-04-04"), 
                            by = "days"),
           Deltas = sur.slm_lag11w$deltas,
           tvalue = sur.slm_lag11w$deltas/sur.slm_lag11$deltas.se) %>%
  mutate(sig = ifelse(abs(tvalue) > 1.64, "Significant at 5%", "Not Significant at 5%")) %>%
  ggplot(aes(x = Date, y = Deltas, color = sig)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("Significant at 5%" = "red", "Not Significant at 5%" = "blue")) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = as_date("2020-03-16"), color = "red") +
  theme_tufte()
```

* La estructura de dependencia espacial, pasa de positiva (significativa) a no significativa para finalmente ser negativa (significativa)
* Esto puede explicarse:
- en una PRIMERA ETAPA al inicio del brote epidémico había contagio entre provincias colindantes.
- en una SEGUNDA ETAPA Al introducir medidas de confinamiento las provincias quedaron 'aisladas' y cada una creció a un ritmo diferente. La estructura de dependencia espacial se 'disolvió'
-  en una TERCERA ETAPA, en muchas provincias se controló parcialmente la epidemia. Salvo en X-provincias que siguieron creciendo fuertemente. Eso dio lugar a patrones de dependencia espacial negativa.

# Analisis of autocorrelated residuals

Extract residuals for March 14 and April 2, and compute autocorrelated residuals:
```{r}
residuals_Mar14 <- as.matrix(residuals(sur.slm_lag11w))[[1]]
residuals_Mar14 <- lag.listw(listw, residuals_Mar14)

residuals_Apr04 <- as.matrix(residuals(sur.slm_lag11w))[[22]]
residuals_Apr04 <- lag.listw(listw, residuals_Apr04)
```

Plot residuals on March 14 (positive autocorrelation):
```{r}
covid19_spain %>% filter(Date == "2020-03-14") %>% 
  mutate(ResMarch14 = residuals_Mar14) %>% 
  filter(CCAA != "Canarias") %>%
  ggplot() +
  geom_sf(aes(fill = ResMarch14)) +
  scale_fill_distiller(palette = "RdBu", direction = 1) +
  theme_tufte()
```

Plot residuals on April 4:
```{r}
covid19_spain %>% filter(Date == "2020-03-14") %>% 
  mutate(ResApr04 = residuals_Apr04) %>% 
  filter(CCAA != "Canarias") %>%
  ggplot() +
  geom_sf(aes(fill = ResApr04)) +
  scale_fill_distiller(palette = "RdBu", direction = 1) +
  theme_tufte()
```

## Temporal variation of coefficients of control variables

### Male to Female Ratio

* No es significativa
```{r}
n = 2
data.frame(Date = seq(ymd("2020-03-14"), 
                        ymd("2020-04-04"), 
                            by = "days"),
           Beta = matrix(sur.slm_lag11w$coefficients,ncol = 22)[n,],
           tvalue = matrix(sur.slm_lag11w$coefficients/sur.slm_lag11w$rest.se,ncol = 22)[n,]) %>%
  mutate(sig = ifelse(abs(tvalue) > 1.64, "Significant at 5%", "Not Significant at 5%")) %>%
  ggplot(aes(x = Date, y = Beta, color = sig)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("Significant at 5%" = "red", "Not Significant at 5%" = "blue")) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = as_date("2020-03-16"), color = "red") +
  theme_tufte()
```

### Median Age

* Los coeficientes de las variables de control (EM y HM) tienen el signo esperado
* Los primeros días tienen valores elevados cuando la pandemía no estaba controlada (aún no había confinamiento)
```{r}
n = 3
data.frame(Date = seq(ymd("2020-03-14"), 
                        ymd("2020-04-04"), 
                            by = "days"),
           Beta = matrix(sur.slm_lag11w$coefficients,ncol = 22)[n,],
           tvalue = matrix(sur.slm_lag11w$coefficients/sur.slm_lag11w$rest.se,ncol = 22)[n,]) %>%
  mutate(sig = ifelse(abs(tvalue) > 1.64, "Significant at 5%", "Not Significant at 5%")) %>%
  ggplot(aes(x = Date, y = Beta, color = sig)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("Significant at 5%" = "red", "Not Significant at 5%" = "blue")) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = as_date("2020-03-16"), color = "red") +
  theme_tufte()
```

## Dinámica temporal de Variables Climáticas

### TEMPERATURA

* Los coeficientes de las variables de control (EM y HM) tienen el signo esperado
* Los primeros días tienen valores elevados cuando la pandemía no estaba controlada (aún no había confinamiento)
```{r}
n = 4
data.frame(Date = seq(ymd("2020-03-14"), 
                        ymd("2020-04-04"), 
                            by = "days"),
           Beta = matrix(sur.slm_lag11w$coefficients,ncol = 22)[n,],
           tvalue = matrix(sur.slm_lag11w$coefficients/sur.slm_lag11$rest.se,ncol = 22)[n,]) %>%
  mutate(sig = ifelse(abs(tvalue) > 1.64, "Significant at 5%", "Not Significant at 5%")) %>%
  ggplot(aes(x = Date, y = Beta, color = sig)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("Significant at 5%" = "red", "Not Significant at 5%" = "blue")) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = as_date("2020-03-16"), color = "red") +
  theme_tufte()
```

### Hours of sunshine

```{r}
n = 5
data.frame(Date = seq(ymd("2020-03-14"), 
                        ymd("2020-04-04"), 
                            by = "days"),
           Beta = matrix(sur.slm_lag11w$coefficients,ncol = 22)[n,],
           tvalue = matrix(sur.slm_lag11w$coefficients/sur.slm_lag11w$rest.se,ncol = 22)[n,]) %>%
  mutate(sig = ifelse(abs(tvalue) > 1.64, "Significant at 5%", "Not Significant at 5%")) %>%
  ggplot(aes(x = Date, y = Beta, color = sig)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("Significant at 5%" = "red", "Not Significant at 5%" = "blue")) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = as_date("2020-03-16"), color = "red") +
  theme_tufte()
```

### Humidity

```{r}
n = 6
data.frame(Date = seq(ymd("2020-03-14"), 
                        ymd("2020-04-04"), 
                            by = "days"),
           Beta = matrix(sur.slm_lag11w$coefficients,ncol = 22)[n,],
           tvalue = matrix(sur.slm_lag11w$coefficients/sur.slm_lag11w$rest.se,ncol = 22)[n,]) %>%
  mutate(sig = ifelse(abs(tvalue) > 1.64, "Significant at 5%", "Not Significant at 5%")) %>%
  ggplot(aes(x = Date, y = Beta, color = sig)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("Significant at 5%" = "red", "Not Significant at 5%" = "blue")) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = as_date("2020-03-16"), color = "red") +
  theme_tufte()
```

### Intercept

```{r}
n = 1
data.frame(Date = seq(ymd("2020-03-14"), 
                        ymd("2020-04-04"), 
                            by = "days"),
           Beta = matrix(sur.slm_lag11w$coefficients,ncol = 22)[n,],
           tvalue = matrix(sur.slm_lag11w$coefficients/sur.slm_lag11w$rest.se,ncol = 22)[n,]) %>%
  mutate(sig = ifelse(abs(tvalue) > 1.64, "Significant at 5%", "Not Significant at 5%")) %>%
  ggplot(aes(x = Date, y = Beta, color = sig)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("Significant at 5%" = "red", "Not Significant at 5%" = "blue")) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = as_date("2020-03-16"), color = "red") +
  theme_tufte()
```